# Linux system administration
### Contents
  * [Linux System](#Linux)
  * [Installation](#Installation)
  * [Package](#Package)
  * [Processes and Monitoring](#Processes)
  * [User Management](#Users)
  * [Service](#Service)
  * [File system](#Filesystem)
  * [Shell](#Shell)
  * [Files and Directories](#Files)
  * [Logging](#Logging)

    Network and Security issues are covered in another session
    https://github.com/DongheeKang/MLOps_Note/blob/main/linux_network.md


Technical Recommendations:
  * Software Sources and Installation
  * Software and System Maintenance
  * Service Management
  * Bootstrapping systems
  * Logging
  * User and Group
  * Tools
  * Scripting
  * FileSystem locations
  * Web Servers
  * Security
  * SSH
  * SSL/TLS
  * VPN

<br/><a name="Linux System"></a>

# Linux System

    ===============================================================================================
    System fundamental
    ===============================================================================================
    - Kernel
      $ cat /proc/modules        : running module by current kernel
      $ cat /etc/modprob.d       : configuration data for modprod
      $ uname -r                 : print of current version of kernel
      $ lsmod | grep xfs	       : show info. about loaded xfs modules
      $ modinfo          	       : print of loaded modules in detail (with su)
      $ modprobe xfs             : load xfs module
      $ modprobe -r kvm	         : extract kvm module
      $ depmod -n 		           : wie depmod die Datei modules.dep konfig.

      Kernel location? Module des Kernels
      $ cat /lib/modules/<kernel version>/xxx

      kernel-Quelldateien
      $ /usr/src/linux-2.6.11.4-21.9
      Patch of kernel
      $ bzip2 -dc patch-2.6.39-rc4.bz2 | patch -p1 --dry-run
      Modify kernel paramaters at runtime, listed under /proc/sys/
      $ sysctl -w net.ipv6.conf.all.forwarding=1  : write into /proc/sys/net../forwarding
      $ sysctl -w net.ipv6.conf.all.forwarding=1  : write into /proc/sys/net../forwarding
      $ sysctl kernel.shmmax=212222222            : write into /proc/sys/kernel/shmmax

    - /proc
      Prozessdateisystem, runtime kernel module infromation
      $ cat /proc/cmdline        : from the bootloader to the kernel
      $ cat /proc/interrupts     : Info. about IRQs
      $ cat /proc/ioports        : Info. about I/O ports

    - /sys
      benutzer Treibermodell des laufendern Kernels, dynamische generiert wird

    - /dev
      udev            : To manage the /dev tree
      rdev            : query/set image root device, swap, RAM size, or video mode
      /dev/mapper     : hold device files related to LVM and RAID configuration
      udevadm monitor : new monitor

    - /usr
      unix system resource - suggest read only
      executable programs that are not needed on boot

    - /var
      temporally used system related files
      /var/log           : system log files
      /var/spool/mail    : grosser platz empfolen
      /var/named         : DNS zone configuration file
      /var/spool/cron    : cron temporal configuration data
      /var/log/messages  : Hauptprotokolldatei in Linux
      /var/log/syslog    : ausser bei Debian und Derivaten

    - /boot
      To have GRUB rescan all of the devices, the device.map
      /boot/grub/device.map          : generated by grub-mkdevicemap
      This file tell the paths of the fs partitions in the GRUB syntax

    - initrd (init ram disk)
      In der initrd befinden sich Kernel-module, die Linux beim Boot-vorgang benoetigt.
      Die initrd wird von Kernel beim System start in den Hauptspeicher geladen
      Die initrd muss bei jedem Kernel-Update nue erstellt werden

    - Drei Wesentliche Initialisierungsverfahren fuer den Linux-Systemstart:
      SysVinit (wird kamm mehr benutzt)                 : linux system
      Upstart  (Ubuntu, in zwischen night mehr aktuell) : linux system
      Systemd  (inzwischen von allen grossen Distributionen eingesetzt)

    - SysVinit or init:
      $ cat /etc/inittab    : main configuration file

      /etc/init.d/      : init process or
      /etc/rc.d/        : init process
      /etc/init.d/rc0.d : symbolic link of /etc/init.d/*  or
      /etc/rc0.d        : symbolic link of /etc/init.d/*

      $ telinit q    : read inittab configuration again and go back to previous state
                       without restart, tell init to re-examine the /etc/inittab
      $ update-rd.d  : install the init script links, use update-rc.d (Debian)
      $ chkconfig    : install and remove the init script links, use this (RedHat)
      $ sysv-rc-conf : command for the runlevel behavior for various services
      $ service --status-all

    - Systemd
      $ Systemctl start|stop|status <Subsystem>
      wenn Sie systemd, dann kommt journald & journalctl

    - How do I know whether systemd, SysVinit or upstart is used for system start?
      $ ps -A
      $ pstree
      $ sudo stat /proc/1/exe
      $ rpm -qf /sbin/init

    - Distribution Packages
      apt-get, dpkg, yum, rpm

    - Was muss gesichert werden?
      /bin    : backup
      /boot   : backup
      /etc    : backup, but no /etc/mtab
      /home   : backup
      /lib    : backup
      /opt    : backup
      /root   : backup
      /sbin   : backup
      /usr    : backup
      /var    : backup weil mailservern
      /sys    : no
      /dev    : no
      /mnt    : no
      /proc   : no
      /tmp    : no



### init
    ===============================================================================================
    init (SysVinit)
    ===============================================================================================
    - Setup to start automatically after a crash or reboot
      Runlevel 0  : System shutdown
      Runlevel 1  : Single-user, rescue mode
      Runlevel 2-4: Multi-user, text mode with networking enabled
      Runlevel 5  : Multi-user, network enabled, graphical mode
      Runlevel 6  : System reboot

    - System V Init Sequence
      1. The init daemon is created from the binary file /sbin/init
      2. The first file the init daemon reads is /etc/inittab
      3. One of the entries in this file decides the runlevel the machine should boot into.
      4. Next, the init daemon looks further into the /etc/inittab file and reads configuration

      Looking at inittab -> rc(run command) -> init directory
      $ cat /etc/inittab | grep initdefault
      $ cat /etc/inittab | grep Runlevel
      $ ls -ld /etc/rc*.d
      $ ls -l /etc/rc2.d
      |S01rsyslog -> ../init.d/rsyslog
      |S02anacron -> ../init.d/anacron
      |S02atd -> ../init.d/atd
      |S02cron -> ../init.d/cron
      |S02mysql -> ../init.d/mysql
      |S02ssh -> ../init.d/ssh
      $ ls -l /etc/init.d/my*
      $ cat /etc/init.d/mysql | less

      Using chkconfig or sysv-rc-conf, alternatively to look init setup
      $ chkonfig --list | grep service_name     : for centOS
      $ sudo apt-get install sysv-rc-conf -y    : for Debian
      $ sudo sysv-rc-conf                       <---- very nice tool!

    - Init for MySQL
      MySQL Startup Behavior at Boot
      $ sudo update-rc.d mysql disable
      $ sudo update-rc.d mysql enable
      $ ls -l /etc/rc2.d

      MySQL Start-up Behavior on Crash
      $ cat /etc/inittab
      | ms:2345:respawn:/bin/sh /usr/bin/mysqld_safe
      $ sudo reboot
      $ ps -ef | grep mysql
      | root    907    1 00:00:00  /bin/sh /usr/bin/mysqld_safe
      |mysql   1031  907 00:00:00  /usr/sbin/mysqld --basedir=/usr ...
      Kill the MySQL
      $ sudo kill -9 907
      $ sudo kill -9 1031
      Wait 5 minutes, then check mysql is still in working!
      $ sudo service mysql status

### Systemd
    ===============================================================================================
    Systemd
    ===============================================================================================
    - Systemd sequence
      runlevel 0 	  poweroff.target
      runlevel 1 	  resuce.target
      runlevel 2-4  multi-user.target
      runlevel 5 	  graphical.target
      runlevel 6 	  reboot.target

      /lib/systemd/system/
      /etc/systemd/system/

      Looking at the default.target File and Dependencies
      $ sudo ls -l /etc/systemd/system/default.target
      | ... /etc/systemd/system/default.target -> /lib/systemd/system/multi-user.target

      $ sudo ls -l /etc/systemd/system/multi-user.target.wants/*.service
      |/etc/.../multi-user.target.wants/crond.service -> /usr/lib/systemd/system/crond.service
      |/etc/.../multi-user.target.wants/mysqld.service -> /usr/lib/systemd/system/mysqld.service
      | ...
      |/etc/.../multi-user.target.wants/sshd.service -> /usr/lib/systemd/system/sshd.service

      $ sudo systemctl show --property "Wants" multi-user.target | fmt -10 | grep mysql
      | Requires=basic.target

      $ sudo systemctl show --property "Requires" basic.target | fmt -10
      | Requires=sysinit.target

      $ sudo systemctl show --property "Wants" sysinit.target | fmt -10
      |Wants=local-fs.target
      |swap.target
      |cryptsetup.target
      |systemd-udevd.service
      |systemd-update-utmp.service
      |systemd-journal-flush.service
      |...

      Looking at a Unit File
      $ sudo nano /etc/systemd/system/multi-user.target.wants/sshd.service
      |[Unit]
      |Description=OpenSSH server daemon
      |After=syslog.target network.target auditd.service
      |[Service]
      |EnvironmentFile=/etc/sysconfig/sshd
      |ExecStartPre=/usr/sbin/sshd-keygen
      |ExecStart=/usr/sbin/sshd -D $OPTIONS
      |ExecReload=/bin/kill -HUP $MAINPID
      |KillMode=process
      |Restart=on-failure
      |RestartSec=42s
      |[Install]
      |WantedBy=multi-user.target

    - systemd + mysql
      MySQL Startup Behavior at Boot
      $ sudo systemctl disable mysqld.service
      $ sudo systemctl enable mysqld.service
      $ sudo systemctl show --property "Wants" multi-user.target | fmt -10 | grep mysql
      $ sudo ls -l /etc/systemd/system/multi-user.target.wants/mysql*

      MySQL Startup Behavior on Crash
      $ sudo nano /etc/systemd/system/multi-user.target.wants/mysqld.service
      |[Unit]
      |...
      |[Install]
      |...
      |[Service]
      |...
      |Restart=always               <--- this is important piece
      |...
      $ sudo systemctl daemon-reload
      $ sudo systemctl restart mysqld.service
      $ sudo systemctl status mysqld.service
      $ sudo kill -9 11217
      Still survice mysql as wish
      $ sudo systemctl status mysqld.service


<br/><a name="Linux installation"></a>

# Installation
### Initial setup after installation (based on ubuntu)

    1. root login
      $ ssh root@123.456.789.100
      |
      | warning..... bla blaa
      |
      $ ssh-keygen -R 123.456.789.100    : remove old key for root of 123.456.789.100
      $ eval `ssh-agent -s`              : check ssh-agent of local machine
      $ ssh-add ~/.ssh/id_rsa            : add private key to local machine
      $ ssh root@123.456.789.100         : try again, now OK with root!

    2. create user admin, who has root privileges
      $ adduser admin

    3. root privileges
      $ gpasswd -a admin sudo

    4. Add Public Key Authentication to admin user  : this is realy interesting!
      Generate a Key Pair
      $ ssh-keygen
      Enter file in which to save the key (/Users/localuser/.ssh/id_rsa): <enter>
      | ~/.ssh/id_rsa        (private key)
      | ~/.ssh/id_ras.pub    (public key)

      Copy the Public Key,
      $ ssh-copy-id demo@SERVER_IP_ADDRESS
      or
      $ cat ~/.ssh/id_rsa.pub
      | ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAA...rggpFmu3HbXBnWSUdf localuser@machine.local
      | ctrl + c
      $ su - admin
      $ mkdir .ssh
      $ chmod 700 .ssh
      $ nano .ssh/authorized_keys
      | ctrl + v
      $ chmod 600 .ssh/authorized_keys

    5. Configure SSH Daemon
      $ nano /etc/ssh/sshd_config
      | PermitRootLogin no                : disabling remote root login is highly recommended

    6. Reload SSH
      $ service ssh restart
      $ ssh demo@SERVER_IP_ADDRESS        : it work! login with demo accout from local to server

    Optional) additional Recommended Steps
    7. Firewall policies
      $ sudo aptitude install ufw
      $ sudo ufw status

      $ sudo ufw allow ssh                     : to configure your firewall policies
      $ sudo ufw allow 4444/tcp                : extra SSH 2222
      $ sudo ufw allow 80/tcp                  : HTTP
      $ sudo ufw allow 443/tcp                 : SSL/TLS
      $ sudo ufw allow 25/tcp                  : SMTP
      $ sudo ufw allow 21/tcp                  : ftp
      $ sudo ufw show added                    : finalized
      $ sudo ufw enable                        : confirm then type "y"
      $ sudo ufw allow from 192.168.255.255
      $ sudo ufw default deny incoming
      $ sudo ufw default deny outgoing
      $ sudo ufw delete allow 80/tcp
      $ sudo ufw delete allow 1000:2000/tcp

    8. Configure Timezones and Network Time Protocol Synchronization
      $ sudo dpkg-reconfigure tzdata
      $ sudo apt-get update
      $ sudo apt-get install ntp

    9. Create a Swap File
      $ sudo fallocate -l 4G /swapfile
      $ sudo chmod 600 /swapfile
      $ sudo mkswap /swapfile
      $ sudo swapon /swapfile
      $ sudo sh -c 'echo "/swapfile none swap sw 0 0" >> /etc/fstab'




<br/><a name="Linux package"></a>

# Linux package

### dpkg

    Originally used by Debian and now by Ubuntu. Uses the .deb format and was the first to have a widely known dependency resolution tool, APT. The ncurses-based front-end for APT, aptitude, is also a popular package manager for Debian-based systems.

      $ dpkg -i <package_name>
      $ dpkg -Gi package(s).deb          install/upgrade package file(s)
      $ dpkg -r package                  remove package
      $ dpkg -l '*spell*'                show all packages whose names contain the spell
      $ dpkg -l package                  show version of package installed
      $ dpkg -s package                  show all package metadata
      $ dpkg -I package.deb              show all package file's metadata
      $ dpkg -S /path/file               what package does file belong
      $ dpkg -L package                  list where files were installed
      $ dpkg -c package.deb              list where files would be installed
      $ dpkg -x package.deb              extract package files to current dir
      $ dpkg -s package | grep ^Depends  list files/packages that package needs
      $ dpkg --purge --dry-run package	 list packages that need package (see also whatrequires)

      $ dpkg -b example
      $ dpkg-deb --build helloworld_1.0-1
      | Package: backup-script
      | Architecture: all
      | Maintainer: Bas van Schaik
      | Depends: debconf (>= 0.5.00), rsync
      | Priority: optional
      | Version: 0.5
      | Description: My Simple backup script
      | This script provides an easy way of creating backups
      | .
      | Creating backups is now more fun than ever!

### RPM 

    Created by Red Hat. RPM is the Linux Standard Base packaging format and the base of a number of additional tools, including apt4rpm, Red Hat's up2date, Mandriva's urpmi, openSUSE's ZYpp, PLD Linux's poldek, and YUM, which is used by Fedora, Red Hat Enterprise Linux, and Yellow Dog Linux.

      $ rpm -Uvh packages(s).rpm          install/upgrade package file(s)
      $ rpm -e package                    remove package
      $ rpm -qa '*spell*'                 show all packages whose names contain the spell
      $ rpm -q package                    show version of package installed
      $ rpm -q -i package                 show all package metadata
      $ rpm -q -i -p package.rpm          show all package file's metadata
      $ rpm -q -f /path/file              what package does file belong
      $ rpm -q -l package                 list where files were installed
      $ rpm -q -l -p package.rpm          list where files would be installed
      $ rpm2cpio package.rpm | cpio -id   extract package files to current dir

      $ rpmdev-newspec
      $ rpmbuild -ba hello.spec
      | Name:     hello
      | Version:  2.8
      | Release:  1
      | Summary:  The "Hello World" program from GNU
      | License:  GPLv3+
      | URL:      https://www.gnu.org/software/hello/
      | Source0:  http://ftp.gnu.org/gnu/hello/hello-2.8.tar.gz
      | %description
      | The "Hello World" program, done with all bells and whistles of a proper FOSS
      | project, including configuration, build, internationalization, help files, etc.
      | %changelog
      | * Thu Jul 07 2011 The Coon of Ty <Ty@coon.org> - 2.8-1
      | - Initial version of the package

### apt-get

* *How to find out the packages

      $ sudo apt-cache search “metasearch engine”                : keyword
      $ sudo apt-cache show apache2                              : package name

      $ dpkg -l *<search_term>*               : whether a package is installed or not installed

* How to upgrade packages

      $ sudo apt-get update && apt-get dist-upgrade 

      apt-get dist-upgrade vs apt-get upgrade
     
      $ apt-get upgrade
      upgrades all installed packages. This is the equivalent of "Mark all upgrades" in Synaptic

* How to clean up

      $ apt-get autoclean
      $ apt-get clean
      The same as above, except it removes all packages from the package cache.

* Removal commands

      $ apt-get remove <package_name>
      $ apt-get purge <package_name>

### put the list for unbuntu library
* legacy

      $ vi /etc/apt/sources.list

      deb http://security.ubuntu.com/ubuntu intrepid-security main
      deb http://download.virtualbox.org/virtualbox/debian lucid non-free
      deb http://archive.canonical.com/ lucid partner

      $ sudo apt-get update

* modern way

      add
      $ sudo add-apt-repository ppa:thomas-schiex/blender

      remove
      $ sudo add-apt-repository --remove ppa:thomas-schiex/blender

      fix for "command not found" by installing software-properties-common package
      $ sudo apt install software-properties-common -y

### What is the apt equivalent to these dselect commands?
    https://unix.stackexchange.com/questions/361219/what-is-the-apt-equivalent-to-these-dselect-commands


<br/><a name="Processes"></a>

# Processes and Monitoring

### The Linux Process States
  
  * Running or Runnable (R)
  * Uninterruptible Sleep (D)
  * Interruptable Sleep (S)
  * Stopped (T)
  * Zombie (Z)

### Monitoring command set
* ps

      $ ps -e -f                    : all process
      $ ps -a                       : current shall
      $ ps -C systemd               : filter by systemd
      $ ps -u root                  : filter by user(effective)
      $ ps -p 1, 293                : filter by pid
      $ ps -C gedit -L -f           : thread by -L
      $ ps -e -H                    : child process by -H 
* top  

      $ top -p 23584,22011
      $ top -u root

      keys 
      -------------------------------------------------
      us – user processes
      sy – kernel processes
      ni – niced user processes
      id – kernel idle handler
      wa – I/O completion
      hi – hardware interrupts
      si – software interrupts
      st – time stolen from this VM by the hypervisor
      -------------------------------------------------
* /proc

      $ cat /proc/{pid}/status | grep State


* /var  

      /var/run/utmp   : maintains a full accounting of the current status of the system
      /var/log/wtmp   : acts as a historical utmp
      /var/log/btmp   : records only failed login attempts. 

* sysstat

      sudo apt-get install sysstat

      commands 
      --------------------------------------------------------------------------------------------------
      iostat     : reports CPU statistics and input/output statistics for block devices and partitions.
      mpstat     : reports individual or combined processor related statistics.
      pidstat    : reports statistics for Linux tasks (processes) : I/O, CPU, memory, etc.
      tapestat   : reports statistics for tape drives connected to the system.
      cifsiostat : reports CIFS statistics.
      --------------------------------------------------------------------------------------------------

      vmstat is for virtual memory, but cover CPU, memory, and I/O

### RAM

* Find Out the Total Physical Memory (RAM) on Linux

      $ free -h -t          : to know the amount of RAM and swap used/free memory combined
      $ free -h -s 5        : useful if we want to monitor the RAM usage at a specified interval

      $ vmstat -w 
      $ vmstat -s 
      $ vmstat -s | grep -i 'total memory' | sed 's/ *//'
      $ vmstat 2 6           : every 2 secs for 6 intervals

      $ dmidecode --type 19

      $ cat /proc/cpuinfo | grep core

      nice tool for memory monitoring
      $ ksysguard

      one liner log for memory
      $ while true; do date >> memory.log; free >> memory.log; sleep 1; done

* RAM informantion (virtual file)

      $ vi /proc/meminfo
      $ cat /proc/meminfo | grep -i 'memtotal' | grep -o '[[:digit:]]*'

### CPU

* Overall CPU Usage on Linux

      $ uptime
      $ vmstat 3 4
      $ vmstat 1 2|tail -1|awk '{print $15}'
         
      $ vi /proc/stat

      $ cat /proc/stat |grep cpu |tail -1|awk '{print ($5*100)/($2+$3+$4+$5+$6+$7+$8+$9+$10)}'|awk '{print "CPU Usage: " 100-$1 "%"}'
      CPU Usage: 2.4219 %

      $ top -bn2 | grep '%Cpu' | tail -1 | grep -P '(....|...) id,'|awk '{print "CPU Usage: " 100-$8 "%"}'
      CPU Usage: 2.2%

* CPU informantion (virtual file)

  The /proc/cpuinfo virtual file contains information about the CPUs currently available in our system’s motherboard.

      $ vi /proc/cpuinfo

      lm              : whether 64-bit support? 
      vmx             : CPU has hardware support for virtual machines. 

### strace (System call) 

strace is a diagnistic tool for system calls that result in error will have their error exit code and a description displayed

    $ sh -c 'echo $$; exec sleep 60'                      : Attaching strace to Running Process
    $ strace -p {PID}

    $ strace -c whoami                                    : To get a summary of the command, we can use the flag -c
    $ strace -t whoami                                    : Obtaining Timing Information
    $ strace -e trace=fstat whoami                        : Filtering With Expression
    $ strace -e status=!successful whoami                 : Filtering Output by Return Status

### How to monitor disk I/O in a Linux system

* Report Disk I/O Statistics

      $ iostat -d 
      $ iostat -d -p sda                                    : specified device.
      $ iostat -N                                           : Display LVM Statistics  
 
* Identify which process or thread is causing heavy I/O activities.

      $ egrep '(CONFIG_VM_EVENT_COUNTERS|TASK_IO_ACCOUNTING|CONFIG_TASKSTATS|TASK_DELAY_ACCT)' /boot/config-$(uname -r)
      $ sudo iotop -o                                       : threads actually performing I/O activity

* Generate Disk I/O Statistics Over a Period of Time

      $ sar  -b 1                                  : to report details about the disk activities:
      $ sar -p -d -b 1                             : identify devices by using -p, for each block device using -d 
      $ sar 2 5 -o /tmp/data_io > /dev/null 2>&1   : saved file is in a binary format
      $ sar -f /tmp/data_io                        : to read the report generated by the sar command saved in the file

* Measure Disk I/O Usage With vmstat
      
      $ vmstat -d 1                                : to display individual disk statistics:
      $ vmstat -p /dev/sda2 1                      : -p to obtain detailed performance statistics about a partition

### How to know runnning child processes?
  
    $ pgrep -lP 6245
    $ pstree -p 6245
    $ ps --ppid 6245
    $ cat /proc/6245/task/6245/children
      
    please have a look dedicated script find_child_process.sh in github

### How to kill a process standard way?

    $ pgrep -fa dummy_process                : find and list for certain process name, if you want to filter

    $ pkill -f dummy_process                 : kill matches the given process name.
    $ killall dd                             : Kill Multiple Processes Using killall

    $ pidof dummy_process | xargs -r kill    : find pid and kill it

### How to kill backgournd process?

    $ ps -eaf                     : find pid
    $ pgrep chrome                : program name (firefox)
    $ jobs                        : to list job (& is background)

    $ sudo kill -9 733
    $ sudo pkill rabbitmq
    $ killall chrome
    $ killall firefox

    $ fg 1                        : bring first into foreground
    $ kill %1                     : kill id=1 process

### How long a linux process has been running?

    $ ps -p 1234 -o etime                      :  03:24:30
    $ ps -p 1234 -o etimes                     :  timestemp 123445

### Finding out who killed the process

    $ (echo "li = []" ; echo "for r in range(9999999999999999): li.append(str(r))") | python

    $ sudo dmesg | tail -7

    $ journalctl --list-boots | \
      awk '{ print $1 }' | \
      xargs -I{} journalctl --utc --no-pager -b {} -kqg 'killed process' -o verbose --output-fields=MESSAGE

### Find the current working directory of a running process

    $ pgrep sleep
      5620                               : this is a pid

    $ pwdx 5620                          : use now pwdx
      5620: /home/pi                     : can find directory!

    $ lsof -p 5620 | grep cwd            : or also possible with lsof

    $ readlink -e /proc/23217/cwd        : or readlink


### Advanced monitoring solutions
    Monitoring solutions (network and system)
      Nagios, MRTG(Multi Router Traffic Grapher), Cacti, Wireshark, Icinga2
      collectd(system statistics collection daemon for IT infrastructure)
      cloudwatch, rackspace, prometheus    

<br/><a name="Users"></a>

# User Management

### su or sudo
    su (substitue user)
    sudo (Super User DO)

### visudo 
    
    will show /etc/sudoers
    
      $ visudo 
        root  ALL=(ALL:ALL) ALL
        user hostname=(runas-user:runas-group) command

    add 'donghee' user account to the super user / admin group

      usermod -aG sudo donghee
      usermod -aG admin donghee

### Running a script or command as another user in Linux

* method 1 (su way)

      $ cat > /home/annie/annie-script.sh <<EOF
        echo "Running annie-script.sh as user $(whoami)"
        EOF
      $ chmod u+x /home/annie/annie-script.sh

      login as donghee 
      $ su -c '/home/annie/annie-script.sh' annie    : Running annie-script.sh as user annie
      $ su -c 'echo I am $(whoami)'                  : Running annie-script.sh as user root

      Disabling the password prompt:
      $ vi /etc/pam.d/su
        auth  [success=ignore default=1] pam_succeed_if.so user = annie
        auth  sufficient                 pam_succeed_if.so use_uid user = dave

      $ su -c /home/annie/annie-script.sh annie
        Running annie-script.sh as user annie

* method 2 (sudo way)

      Edit the /etc/sudoers file
      $ echo 'dave ALL=(annie) /home/annie/annie-script.sh' | EDITOR='tee -a' visudo
    
      $ sudo -u annie /home/annie/annie-script.sh
        [sudo] password for donghee:                 : with sudo, it requests for the current user’s password
        Running annie-script.sh as user annie

      Allow execute script by root i.e. system  
      $ echo 'dave ALL=(ALL) /home/annie/annie-script.sh' | EDITOR='tee -a' visudo

      Now it should work!
      $ sudo -u root /home/annie/annie-script.sh
        [sudo] password for donghee:
        Running annie-script.sh as user root

      Skipping Password Prompt
      $ cat /etc/sudoers
        dave ALL=(ALL) NOPASSWD: /home/annie/annie-script.sh
        admin ALL = (root) NOPASSWD: ALL
        user ALL = (root) /usr/bin/apt-get update, /usr/bin/apt-get dist-upgrade

      $ sudo -u annie /home/annie/annie-script.sh
        Running annie-script.sh as user annie
      $ sudo -u root /home/annie/annie-script.sh
        Running annie-script.sh as user root

### su or su -

    compare below two without '-' and with '-'

      $ su - 
        root@server:~# pwd 
        /root 
      $ su  
        root@server:/home/test# pwd 
        /home/test      

      $ sudo su                    : simple su is not working at ubuntu  
      $ su                         : simple su is not working at ubuntu ? 

### User and group

      /etc/passwd
      /etc/shadow
      /etc/group

      $ useradd              : without -m means NO home directoy
      $ adduser              : some distribution also possible
      $ userdel              : delete recursively home and also mail spool
      $ usermod              : modification of user account

      $ groupadd
      $ groupdel
      $ groupmod
      $ gpasswd

### How to allow to login to system with a permission? 

      /etc/nologin
      /etc/hosts.allow
      /etc/hosts.deny
      $ vi /etc/security/limits.conf
      $ vi /etc/security/access.conf
      $ chsh -s /bin/false kang                 : user kang can not access anything!

### How to change the default home directory of a user

    As a default one can create user in /home/ 
    $ sudo useradd -d /home/kang -m kang         : -m for user -d for directory

    $ sudo useradd -m donghee                           
    $ sudo useradd -m -d /home/dongheekang donghee      
    $ sudo passwd kang

    move the existing content to the new location, has to use -m option 
    $ sudo usermod -m -d /usr/dongheekang dongheekang


    /etc/skel       : automatically copied files under this directory over to a new user's home directory

### add user but disable login 

     sudo adduser --disabled-login --gecos 'GitLab' git    

     --disabled-login                           : login is deactivated, user will be unable to login
     --gecos 'Donald Trump,3,,,President'       : full name, Room number, Work phone, Home phone, other

     $ getent shadow git
       git:*:15998::::::

       *  = The account is deactivated & locked
       !  = The login is deactivated, user will be unable to login
       !!  = The password has expired

### PAM (Pluggable Authentication Modules)
    
    /lib/security/pam_ldap.so   : configures authentication via LDAP.
    /lib/security/pam_securetty : user allow to log in as root, when /etc/securetty exists

    Those data location is related with PAM modules
    /etc/security/opasswd       : old password is saved into
    /etc/security/limits.d      : default limits are taken from
    /etc/security/limits.conf   : configuration of limitatio

    If you want to deny some users from ssh connection,
    $ vi /etc/nosshuser
    $ vi /etc/pam.d/sshd
      auth required pam_listfile.so item=user sense=deny file=/etc/nosshuser

    If you want to allow users, then do this
    $ vi /etc/sshuser
    $ vi /etc/pam.d/sshd
      auth required pam_listfile.so item=user sense=allow file=/etc/sshuser

    Simple way to deny any user login
      $ vi /etc/nologin
      $ vi /etc/pam.d/login

### List all groups in linux

* standard method

      $ vi /etc/group
      group_name : password(encrypted) : GID : user_list
      root:x:0:root
      bin:x:1:root,bin,daemon
      daemon:x:2:root,bin,daemon
      sys:x:3:root,bin
      adm:x:4:root,daemon
      tty:x:5:
      disk:x:6:root
      lp:x:7:cups,daemon,kent

      only user print out! 
      $ cut -d: -f1 /etc/group

* getent 

      $ getent group

      only user print out! 
      $ getent group | cut -d: -f1

      $ getent passwd kang         : Check a user whether exist or not

* group

      $ groups                         : list of all group
      lp wheel dbus network video audio optical storage input users vboxusers docker donghee
    
      $ groups root                    : list of all group for this user
      root bin daemon sys adm disk wheel log

* id

      $ id kang            : display UID and GID
      $ id -Gn
      $ id -Gn root

### How to generates a compact listing of all the users on the system

    $ cut -d: -f < /etc/passwd | sort | xargs echo

### Modification I

* How to change password for other user account?

    only with super user
    $ su -

    check password of user first 
    $ getent passwd | grep donghee
    $ passwd donghee    
    $ passwd -V donghee                 : to view password status

    *** this is important!           
    $ sudo passwd           : if passwd with no specified user, then will change password for root

* Forcing user to change password at their next login

    Let us immediately expire an account’s password

    $ sudo passwd -e donghee
    $ sudo passwd --expire donghee

* Extend expire date of user

    $ usermod -e 2025-09-01 user

* Lock and unlock of user    

    $ usermod -L user
    $ usermod -U user 

* Change account’s username

    $ usermod -l old new

### Modification II 

    $ chage -l kang        : administrative tool for passwd and expiring date
    $ chfn & finger        : change personal data as like name, telefone, office number
    $ newgrp newgroup      : change primary group by newgroup from normal user
          
    Befehle zur Verwaltung des Shadow-Systems
    $ pwconv               : transferieren der Passwort-Hashes aus passwd -> nach shadow
    $ pwunconv             : shadow -> passwd
    $ pwck                 : Konsistenz von passwd u. shadow ueberpruefen

    $ grpconv
    $ grpunconv
    $ grpck

### To create a user group and add one user into there
    
    $ sudo addgroup administrator
    $ sudo adduser donghee administrator

    Add existing user to sudo group
    $ sudo usermod -aG sudo donghee

### Fixing the “Command Not Found” Error When Using Sudo 
  
* “Permission Denied” when running script, then do this

      $ chmod +x ./myscript 

* Fixing the error for a single command. We can pass the -E flag to sudo to make it preserve the current environment variables:

      $ sudo -E myscript

### Why chrooot is important?

    $ apt-get install coreutils
    $ chroot /tmp/new_root /bin/bash
    $ ldd /bin/bash     



<br/><a name="Service"></a>

# Service

### Shutdown linix

    $ shutdown -r now              : reboot
    $ shutdown +30                 : after 30 mins completely shutdown!  
    $ poweroff                     : power off 

### Run a script on startup in Linux
* create a script for reboot message
          
      $ vi reboot_message.sh
        #!/bin/sh \
        echo "Last reboot time: $(date)" > /etc/motd

      $ chmod +x reboot_message.sh

* using cron

      $ crontab -e
      | @reboot sh /root/reboot_message.sh 

* using rc.local 

      $ vi /etc/rc.local 
      |  sh /home/ec2-user/reboot_message.sh
      chmod +x /etc/rc.local
        
      caution) some distribution has another location for rc.local 
      /etc/rc.d/rc.local and one need to care rc0.d, rc1.d and so on.

* using init.d

      $ vi etc/init.d
        #! /bin/sh 
        # chkconfig: 345 99 10
        case "$1" in
        start)
          # Executes our script
          sudo sh /home/ec2-user/reboot_message.sh
          ;; 
        *)
          ;;
        esac
        exit 0 

      $ cd etc/init.d
      $ chkconfig --add service_wrapper.sh        # not in debian
      $ update-rc.d service_wrapper.sh defaults   # use this for debina case

* using systemd
  
      $ vi etc/systemd/system
        [Unit]
        Description=Reboot message systemd service.
        [Service]
        Type=simple
        ExecStart=/bin/bash /home/ec2-user/reboot_message.sh
        [Install]
        WantedBy=multi-user.target

      $ chmod 644 /etc/systemd/system/reboot_message.service
      $ systemctl enable reboot_message.service


### Run an application as a service on linux

you have a service as like java/python application, do registering and then running the service
        
* config service file xxx.service 

      $ vi /etc/systemd/system/javasimple.service
      $ vi /etc/systemd/system/javaforking.service
        [Unit]
        Description=My Java forking service
        After=syslog.target network.target
        [Service]
        SuccessExitStatus=143
        User=appuser
        Group=appgroup
        Type=forking
        ExecStart=/path/to/wrapper
        ExecStop=/bin/kill -15 $MAINPID
        [Install]
        WantedBy=multi-user.target

* use systemctl, start service. 
  
      $ sudo systemctl daemon-reload
      $ sudo systemctl start javasimple.service
      $ sudo systemctl enable javasimple.service
      $ sudo systemctl status javasimple.service

### How to load environment variables in a cron job and, and How to run a script at a certain time on linux? 

* where is the cron? 

      $ ls -l /var/spool/cron/crontabs/              : user-wide
      $ cat /etc/crontab                             : system-wide
        /etc/cron.allow
        /etc/cron.deny

* how to configure crontab

      $ crontab -l
      $ crontab -e 
      
      wrapping and define  
      ---------------------------------------------------------------------------
      * * * * *    ---->     min hour day month week

      * * * * * printenv > /tmp/print_envs_result
      * * * * * BASH_ENV=/etc/profile bash -c "printenv > /tmp/print_envs_result"
      * * * * * bash -l -c "printenv > /tmp/print_envs_result"
      * * * * * BASH_ENV=~/.bashrc bash -l -c "printenv > /tmp/print_envs_result"
      * * * * * /home/dongheekang/backup.sh > /dev/null 2>&1
      @reboot (cd /home/dongheekang/monitoring-scripts; bash monitor-memory.sh)
      ----------------------------------------------------------------------------


### crontab / anacrontab / at

      $ cat /etc/crontab    : crontable
      $ crontab
      $ cat /var/spool/cron/crontab/kang
      # /etc/cron.{d,daily,hourly,monthly,weekly}
      # /etc/cron.allow            : listed user can access
      # /etc/cron.deny             : listed user cannot access, not cron.allow file
      $ cat /etc/anacrontab


### Configure a systemd service to restart periodically

* where is systemd?

      /etc/systemd/system

* write 

      $ sudo vi my-service.service 
        [Unit]
        Description=Simple service
        [Service]
        Type=simple
        ExecStart=/usr/bin/logger hello
        [Install]
        WantedBy=multi-user.target

      $ sudo vi oneshot.service 
        [Unit]
        Description=One shot service
        [Service]
        Type=oneshot
        ExecStart=/usr/bin/systemctl restart my-service.service
        [Install]
        WantedBy=multi-user.target    

      $ sudo vi my-service.timer 
        [Unit]
        Description=Run oneshot service periodically
        [Timer]
        Unit=oneshot.service
        OnCalendar=Mon..Fri 10:30
        [Install]
        WantedBy=timers.target

* run  

      $ systemctl enable --now my-service.timer
      $ systemctl list-timers 
      $ journalctl --since "5 minutes ago"

* run by RuntimeMaxSec and the restart Options

      $ sudo vi my-service1.service 
        [Unit]
        Description=Simple service
        [Service]
        ExecStart=/usr/bin/python3 /root/app.py
        RuntimeMaxSec=180s
        Restart=always
          
* run by crontab  

      $ crontab -e
        30 10 * * 1-5 /usr/bin/systemctl restart my-service.service

### inetd

    Superdaemon, Einen Rechner absichern
      FTP-Server, LPRd, CUPS, TCP/UDP-Dienste wie Daytime, Echo

      Konfigurationsdatei fuer Super Daemon
      /etc/inetd.d/
      /etc/inetd.conf
      /etc/xinetd.d/
      /etc/xinetd.conf

      TCP-Wrapper konfiguration
      /etc/hosts.allow
      /etc/hosts.deny

      tcpchk: eine inetd.conf auf Syntaxfehler pruefen

### Mail service

    * Mail Port
      SMTP 25  : default SMTP
      SMTP 465 : to send messages using SMTP securely
      IMAP 143 : non-encrypted port
      IMAP 993 : using IMAP securely
      POP3 110 : default POP3 non-encrypted port
      POP3 995 : using POP3 securely

    * mail directroy
      /var/spool/mail   : delievered by MDA
      /var/spool/mqueue : auszuliefernde Mail-Queue

      Mail alias by root
      $ vi /etc/aliases

    * SMTP mail server
      Postfix, sendmail, exim, qmail

    * MDA, POP and IMAP server
      dovecot, courier

    * MDA(mail delivery agent)
      Procmail

    General way to test
      $ netcat localhost 25
      $ telnet localhost 25



### sftp

    FTP client Port 21 ---> FTP Server Port 20
    vsftp  Pure-FTPd  ProFTPD  sftp

    $ sftp username@your_server_ip_or_remote_hostname 
    $ sftp -oPort=custom_port username@your_server_ip_or_remote_hostname
### scp(22)

    $ scp -P 22 [user@]SRC_HOST:]file1 [user@]DEST_HOST:]file2
    $ scp file.txt donghee@ip_address_of_remote:/remote/directory
    $ scp -i ~/.ssh/donghee.pem ubuntu@ec2-52-57-133-64.eu-central-1.compute.amazonaws.com:~/data/

     -r: Recursively copy entire directories

    1.scp transfer
      If I want to file transfer From CERN location to Freiburg:
      1.With CERN machine
      scp * donghee@axfr01.physik.uni-freiburg.de:/users/donghee/tmp/
      scp * donghee@pcfr38.physik.uni-freiburg.de:~/tmp/
      scp mc/Aroma/a.f donghee@pcfr38.physik.uni-freiburg.de:~/tmp/
      scp ~/mc/Aroma/* donghee@pcfr38.physik.uni-freiburg.de:~/tmp/
      2.With Freiburg machine
      scp donghee@lxplus.cern.ch:/afs/cern.ch/user/d/donghee/mc/aroma/*.* .
      scp donghee@lxplus.cern.ch:~/mc/aroma/*.* .

    2.scp transfer
      scp -P24 User14.cc donghee@compass.fzk.de:/grid/fzk.de/cvs/User14.cc
      From local to Gridka
      scp -r -P24 AAAAAA donghee@compass.fzk.de:~/work/
      From Gridka to local
      scp -r -P22 AAAAAA donghee@lxplus.cern.ch:~/work/

### rsync

      rsync copy to minidisk per month!
      $ sudo rsync --delete -avv /home/dkang/ /media/Linux/dkang/
      $ sudo rsync --delete -avv /media/Data/Data/ /media/Window/Data/

      copy to Memorystick only important and selected files! per weeks!
      $ sudo rsync --delete --exclude data -avv /home/dkang/GSI/macro_dvcs/ /media/MEMORY/rsync/macro_dvcs/
      $ sudo rsync --delete -avv /home/donghee/Desktop/ /media/MEMORY/rsync/Desktop/
      $ sudo rsync --delete -avv /media/Data/Data/arbeits/analysis-GPDsDVCS/ /media/MEMORY/rsync/analysis-GPDsDVCS/
      $ sudo rsync --delete -avv /media/Data/Data/document/HIM-GSI/ /media/MEMORY/rsync/HIM-GSI/
      $ sudo rsync --delete -avv /media/Data/Data/vortrag/ /media/MEMORY/rsync/vortrag/

      $ sudo rsync --delete --exclude GSI -avv /home/dkang/ /media/Linux/dkang/
      $ sudo rsync --delete -avv /home/dkang/GSI/ /media/Linux/dkang/
      (care about .VirtualBox/HardDisks, that are too heavy)

      $ rsync -a /sc/sc32b/* .
      $ rsync -a /sc/sc32b/* .
### rssh

    A restricted shell and allow only specific protocols such as SCP or SFTP
      $ /usr/local/etc/rssh.conf
      $ /etc/group
      $ /etc/passwd

      $ sudo vim /etc/rssh.conf
        # set the log facility.  "LOG_USER" and "user" are equivalent.
        logfacility = LOG_USER
        allowscp
        #allowsftp
        #allowrsync
        # set the default umask
        umask = 022

### lpr

    printer
      BSD   -> Apple
      SysmV -> Oracle
      CUPS  -> Common Unix Printing System by Apple
  
    lpr
      $ lpr -P color $1       - Color
      $ lpr restart dl1       - Restart
      $ cancel -Pdl1 669      - kill  ???
      $ lpq -Pdl1             - job que
      $ lprm -Pdl1 699        - kill

### postgres
    
    sudo apt install -y postgresql postgresql-client libpq-dev postgresql-contrib
    $ sudo adduser donghee
    $ sudo -i -u donghee

    $ psql
    $ psql -d postgres

    pg> \conninfo

    pg> CREATE TABLE playground (
    pg>   equip_id serial PRIMARY KEY,
    pg>   type varchar (50) NOT NULL,
    pg>   color varchar (25) NOT NULL,
    pg>   location varchar(25) check (location in ('north', 'south', 'west', 'east', 'northeast', 'southeast', 
    pg>   'southwest', 'northwest')),
    pg>   install_date date
    pg> );

    pg> \d                      : see table
    pg> \dt                     : see table
    pg> \q                      : quit
    
    pg> SELECT * FROM playground;

### Elasticsearch
Elasticsearch is a distributed, RESTful search and analytics engine capable of storing data and searching it in near real time.

      index       : database
      type        : table
      document    : row
      field       : column
      mapping     : schema

### Redis

Redis is a data structure store that acts as a NoSQL Database. It is a popular in-memory data platform

      $ sudo apt-get install redis-server


### Web service

- Leading Web Server
      Apache, Microsoft-IIS, nginx, Tomcat, Node.js
      Proxy Server: HAProxy, Nginx, Squid, Varnish are mostly used

      htpasswd can create a password. list to allow access
      $ ./htpasswd kim
      $ vi .htaccess
      $ vi .htgroup

      Certificates are usually stored in /etc/ssl/ or /etc/pki/.
      /etc/ssl/    : the standard location for OpenSSL configuration
      /etc/pki/    : the standard location for PKI (Puclbic Key Infrastructure)

### Apache

      Apache
      /etc/apache2/apache2.conf  @ Debian
      /etc/httpd/conf/httpd.conf @ CentOS

      Apache Module
      /usr/src/mod_php,mod_perl,mod_auth
      OpenSSL(Secure Sockets Layer) + Apache =  Apache-SSL -> mod_ssl

### Ngix

      $ sudo apt-get install -y nginx

      configureation
 
      $ sudo systemctl restart nginx.service

      test
      $ sudo nginx -t

      Nginx with firewall @ CentOS (optional)
      $ sudo firewall-cmd

### Samba

    Samba is the standard Windows interoperability suite of programs for Linux and Unix
    smbd, nmbd, smbstatus, smbpasswd, cifs

### LDAP 

    LDAP permission by SSSD (System Security Services Daemon) to authentication resource
    LDIF (LDAP Data Interchange Format) and (dn: uid=kang, ou=users, dc=linux, dc=net)
    slapadd, slapcat, slapindex
    ldapadd, ldapsearch, ldappasswd, ldapdelete


### Go
 
    - Remove former Go installation folder
    sudo rm -rf /usr/local/go

    - install
    curl --remote-name --location --progress-bar "https://go.dev/dl/go1.17.10.linux-amd64.tar.gz"
    echo '87fc728c9c731e2f74e4a999ef53cf07302d7ed3504b0839027bd9c10edaa3fd  go1.17.10.linux-amd64.tar.gz' | shasum -a256 -c - && \
      sudo tar -C /usr/local -xzf go1.17.10.linux-amd64.tar.gz
    sudo ln -sf /usr/local/go/bin/{go,gofmt} /usr/local/bin/
    rm go1.17.10.linux-amd64.tar.gz

### X server

    Desktops - standard xserver location
    $ crtl+alt+f7
    $ startx                  : ein Frontend fuer das eigentliche Startskript xinit
    $ x :1 -query 10.2.11.21  : show a xserver from Centos in tty8 (differ @ VBox)
    $ xhost +10.2.11.23       : Serverseitige Massnahmen (Debian IP)
    $ xdpyinfo                : X-display variables
    $ xwininfo                : window information utility for X-server



<br/><a name="Filesystem"></a>

# File systems

### Where disk space hss gone on linux
      
First do check disk partition

    df -h                  : human readabel

then do check disk usage 

    du /var
    du -BM --max-depth=1 /var | sort -n | tail -n 5 
    du -BM --max-depth=<strong>2</strong> /var | sort -n | tail -n 5
    du -BM --max-depth=1 <strong>/var/log</strong> | sort -n | tail -n 5


find command

    find /var -size +100M -printf '%s %p\n' | sort -n

sof command delete files still using space: the system does not report space used by deleted files as free

    lsof | grep -E '^COM|deleted'
     
this is really nice tool for checking disk usage!

    ncdu  

### Disk and Storage in Linux

    ===============================================================================================
    Disk and Storage
    ===============================================================================================
    - check current partition
      $ cat /proc/paritions
      $ fdisk -l

    - To display mounted filesystems
      $ fdisk -l
      $ df                : simple and easy
      $ cat /etc/mtab     : check mount option from data table
      $ cat /proc/mounts  : mounted device in current process/session
      $ mount             : list all mounted device currently

    - Automatische Mounten file system via /etc/fstab (6 fields)

    - Disk free (df)  : Displays information on mounted filesystems
      $ df -i   : zeigt mit Inode nicht mit Block

    - Disk utilization (du) : esimate file space usage
      $ du -a   : all

    - create new partion
      $ fdisk /dev/sdb  : MBR partition (4 Primary, 4T total and limit 2.2TB/partition)
      $ gdisk /dev/sdc  : GPT partion   (128 Primary, GUID partition, nur Primary)
      $ parted          : nice method

    - File systems
      ReiserFS, Btrfs, msdos, vfat, ntfs, xfs, cramfs, jfs

    - Formatting/Creating filesystems
      $ mkfs

    - Swap fundamental
      $ cat /proc/swaps
      $ dd if=/dev/zero of=/swapfile bs=1024 count=524288
      $ mkswap
      $ swapon
      $ swapoff

    - chceking filesystems
      $ fsck -c /dev/sdb1
      $ e2fsck -c /dev/sdb1
      $ badbocks /dev/dab1

    - Modyfying, Checking And Repairing Filesystems
      debugfs
      dumpe2fs
      e2fsck
      e2image
      mke2fs
      tune2fs

    - Disk Quotas
      $ quota 	       : see your quota
      $ quotacheck -augv     : all user group verbose, directory quota
      $ quotaon  -avug       : all user group verbose
      $ quataoff -avug       : all user group verbose
      $ edquota -u root      : for root
      $ repquota -v /home    :  Generates quota reports

    - List out information all block devices
      block devices are the hard drive partitions and other storage devices
      $ lsblk
      |NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
      |sda      8:0    0 465.8G  0 disk
      |├─sda1   8:1    0    70G  0 part
      |├─sda2   8:2    0     1K  0 part
      |├─sda5   8:5    0  97.7G  0 part /media/4668484A68483B47
      |├─sda6   8:6    0  97.7G  0 part /
      |├─sda7   8:7    0   1.9G  0 part [SWAP]
      |└─sda8   8:8    0 198.5G  0 part /media/13f35f59-f023-4d98-b06f-9dfaebefd6c1
      |sr0     11:0    1  1024M  0 rom

    - RAID configuration
      $ mdadm                : raid storage
      $ sfdisk               : fancy method
      $ resize2fs /dev/md0   : repossible expand without unmount

    - Adjusting storage device access
      $ hdparm              : IDE/SATA device harddisk standard information
      $ sdparm --enumerate  : summary of SCSI device

    - Attribute of directory
      $ lsattr     	: list of attribute
      $ chattr 	: change of attribute

    - smart
      Self monitoring analysis and reporting technology to monitor hard drive
      $ smartctl -i /dev/sda    : info. about model, serial number, firmware ver.

    - Automounter
      normally "hald" and "dbus" daemon has been used for mount-automatization of drives
      but network resouce "autofs" is better, consists of a kernel component and a daemon

      $ vi /etc/auto.master
      $ vi /etc/auto.misc
      $ /etc/init.d/autofs restart              : apply permanently
      /xxx/xxx will be created by auto.master and auto.netz

    - ISCSI
      Network transmission of scsi protocol via TCP connection
      SCSI (Small Computer System Interface)
      Server : iSCSI-Target
      Client : iSCSI-Initiator

      iscsitarget
      ietd.conf
      iscsid
      iscsiadm
      tgtd

    - WWID, WWN, LUN
      SCSI, SATA, SAS, Fibre has an unique identification by
      SAS (Serial Attached SCSI) and SATA (Serial ATA)
      WWID : World Wide ID        : find at /dev/disk/by-id/
      WWD  : World Wide Name 	    : correspond to WWID
      LUNs : Logical Unit Nummber : is used to address a SCSI device

      If there are multiple paths from a system to a device, a special kernel-module
      and associated daemons and other software will use the WWID to detect the paths.
      /dev/mapper/wwid will be created by them.

      LUN persistence with udev+scsi_id
      $ scsi_id -g -u -s /block/sdc    : find WWID
      $ /lib/udev/scsi_id --page=0x80 --whitelisted /dev/sdb

      LUN persistence can also be made with multipath
      $ multipath -l
      $ cd /dev/mpath/backupdisk

### Encrypted file systems

      Encryption algorithms : Twofish, AES, DES
      A virtual block is created in /dev/mapper (device mapper). All data to and from it goes
      to an encryption or decryption filter before being mapped to another blockdevice

      all relevant modules should be loaded at boot time
      # echo aes >> /etc/modules
      # echo dm_mod >> etc/moduls
      # echo dm_crypt >> /etc/moduls
      # modprobe -a aes dm_mod dm_crypt

      Set up an encrypted filesystem
      $ cryptsetup luksFormat /dev/sdb1         : use /dev/sdb1 partition
      > *****************                       : type the password
      $ cryptsetup luksOpen /dev/sdb1 safe      : create device mapper @ /dev/mapper/safe
      $ mkfs.ext2 /dev/mapper/safe		  : format filesystem
      $ mkdir /safe                             : need a mount point
      $ mount /dev/mapper/safe /safe		  : mount it

### DRBD (Distributed Replicated Block Device)

    - DRBD
      is a software-based, shared-nothing, replicated storage solution mirroring the content
      of block devices (hard disks, partitions, logical volumes etc.) between servers.

      DRBD's core functionality is implemented by way of a Linux kernel module.
      DRBD constitutes a driver for a virtual block device

      LVM setup for DRBD
      lvm, vgchange, drbdadm, vgscan(vgs)

      DRBD with pacemaker
      pacemaker + crm + CIB(Cluster Information Base)

      DRBD with HeartBeat
      Heartbeat + CRM + CIB(xml)

    - DLM (Distributed Lock Manager)
      A distributed lock manager (DLM) provides distributed software applications with a
      means to synchronize their accesses to shared resources. A lock manager is a traffic
      cop who controls access to resources in the cluster, such as access to a GFS

### Other file systems

    - GFS2
      Global File System 2 (GFS2) is a shared disk file system for Linux clusters.
      GFS2 + cLVM(LVM2) + DLM + pacemaker

    - OCFS2
      Oracle Cluster File System (OCFS2) is a shared disk file system

      O2CB manages the shared file access within a cluster of servers
      O2CB cluster stack: Node Manager, Heartbeat, TCP, DLM & DLMFS, CONFIGFS

      OSFS2 + pacemaker + DLM + O2CB + STOHICH

    - Other clustered file systems
      Coda, CephFS, GlusterFS, AFS(Andrew File System), lustre, HDFS, DFS(win), EVMS

### LVM (Logical Volume Manager)

    • LVM
      Logical Volume Manager is an abstraction of physical disk devices and volumes  to volume groups (a virtual disk, multiple disks and storage pool)

        /sbin/pv*   : physical volume - a real partitions with administrative data
        /sbin/lv*   : logical volume - extend block introduced inside volume group
        /sbin/vg*   : volume group - mehreren physikalischen Volumen

      Device mapper at LVM /proc/mapper:
        The device mapper is a kernel driver that provides a framework for volume management.
        It provides a generic way of creating mapped devices, which may be used as LV
        LVM logical volumes are activated using the device mapper.
        Each logical volume is translated into a mapped device.
        Each segment translates into a line in the mapping table that describes the device.

      Partition of device(disk)
      $ fdisk,sfdisk,vgscan

      create a physical volume
      $ pvcreate, pvdisplay

      configuration of volume group
      $ vgcreate, vgdisplay

      configuraion of logical volume
      $ lvcreate, lvdisplay

      Format of LV
      $ mkfs.ext4, mkdir, mount

      Modifying of LV
      $ lvextend, resize2fs, xfs_growfs

      Verkleinern of LV
      $ umount, resize2fs, lvreduce

      Delete PV
      $ vgreduce, vgextend vg_big /dev/sdc1

      LVM snapshots
      $ lvcreate

      If file systems are upgraded and have to move data to new one.
      $ pvmove

      Activate If you meet machine crash, emergency boot, and activate LVM device
      $ vgchange

      Rename of VG and LV
      $ vgrename, lvrename

### Increase LVM Volume
    ===============================================================================================
    Increase LVM volume (from LPIC note)
    ===============================================================================================
    Creation of LVM

      1.LVM installation
        $ yum install lvm2
        $ apt-get install lvm2

      2.Partition of device(disk)
        $ fdisk /dev/sdb
        > n,p,1,t
        > 8e
        > w
        $ sfdisk -d /dev/sdb | sfdisk /dev/sdc
        $ sfdisk -d /dev/sdb | sfdisk /dev/sdd
        $ sfdisk -d /dev/sdb | sfdisk /dev/sde
        $ vgscan -v       : sucht angeschlossene Festplatten nach vg und auch pv!

      3.create a physical volume
        $ pvcreate -v /dev/sdb1
        $ pvcreate -v /dev/sdc1
        $ pvcreate -v /dev/sdd1
        $ pvcreate -v /dev/sde1
        $ pvdisplay

      4.configuration of volume group
        $ vgcreate vg_dig /dev/sdb1 /dev/sdc1 /dev/sdd1 /dev/sde1
        $ vgdisplay

      5.configuraion of logical volume
        $ lvcreate -n lv_big_1 -L 20G vg_big
        $ lvdisplay

      6.Format of LV
        $ mkfs.ext4 /dev/vg_big/lv_big_1
        $ mkdir /mnt
        $ mount /dev/vg_big/lv_big_1 /mnt     : mapper start to come into play
        > /dev/mapper/vg_big-lv_big_1 on /mnt type ext4 (rw)
        $ cp /boot/*  /mnt/

    • Modifying of LV
      Q) If you add some more disk space within Logiral Volume? "lvextend"
        $ lvextend -L 25G /dev/vg_big/lv_big_1
        $ lvextend -L +5G /dev/vg_big/lv_big_1
        $ resize2fs /dev/vg_big/lv_big_1         : automatic
        $ xfs_growfs /dev/vg_big/lv_big_1        : if xfs filesystem is used

      Q) if you want to resize/reduce LV? "lvreduce"
        $ umount /lvtest                         : absolutely neccessary umount
        $ e2fsck -f /dev/vg_big/lv_big_1         : test healthy
        $ resize2fs /dev/vg_big/lv_big_1 1024000 : here is a blcok x 4k = 4GB
        $ lvreduce -L 4G /dev/vg_big/lvbig_1     : also do verkleinern for LV

      Q) if you want to delete physics volume from volume group? "vgreduce, vgextend"
        $ vgreduce -a vg_big              : 4 partition to 1
        $ vgextend vg_big /dev/sdc1       : redefine only first partition into volume group

      Q) LVM snapshots
        the snapshot logical volume only saves data blocks from the original logical volume
        that are changed in the original
        $ lvcreate -L 1G -s -n backup /dev/vg_big/lv_big_1
        $ mount /dev/vg_big/backup /backup
        $ tar -pzcf backup.tar.gz  /backup
        $ umount /backup
        $ lvremove /dev/vg_big/backup
        > y

      Q) If file systems are upgraded and have to move data to new one.
        $ pvmove   /dev/hdb2  /dev/sdc1       : move hdb2 data into sdc1

      Q) Activate If you meet machine crash, emergency boot, and activate LVM device
        $ vgchange -ay            : activate all known volume group's device

      Q) Rename of VG and LV
        $ vgrename vg_orignal vg_new
        $ lvrename MyLVM debian fedora

      Q) What command is used to make an exact copy of a logical volume for backup purposes?
        $ lvcreate (no lvsnapshot)

    • Remark
      sdc (full device) can also be used a volume group, not only sdc1 or sdc2!

#### HANA DB and Storage

    ===============================================================================================
    Upgrade of 'HANA' volume size
    ===============================================================================================
    1. Create the volume in the monsoon dashboard with 200GB volume size

        volume name   : lw_testbase_volume
        volume id     : vol-7ecfa92a
        volume region : Rot DC2
        volume device : /dev/xda (xda=sdb)

    2. Login to the server and perform the following steps

      • In order to get rid of filtering issue of "device /dev/xda not found (or ignored by filtering)"
        I have to comment out filter

        $  vi /etc/lvm/lvm.conf
        | # filter = [ "r|/dev/.*/by-path/.*|", "r|/dev/.*/by-id/.*|", "r|/dev/fd.*|", "r|/dev/cdrom|", "a/.*/" ]
        | filter = [ "r|/dev/fd.*|", "r|/dev/cdrom|", "a/.*/" ]

      • then created file system and copy all HANA related contents into new and extended vlolume place
        $ pvcreate /dev/monsoon/vol-7ecfa92a
        $ vgcreate vg_hana /dev/monsoon/vol-7ecfa92a

        $ lvcreate -l 100%FREE -n lv_hana vg_hana
        $ mkfs.xfs /dev/vg_hana/lv_hana

        $ mkdir /sapmnt/hana

        $ vi /etc/fstab
        | /dev/vg_hana/lv_hana   /sapmnt/hana              xfs defaults  0  0
        $ mount -a

        $ mkdir -p /sapmnt/hana/uar/sap
        $ chown root:sapsys /sapmnt/hana/usr/sap
        $ rsync -av /usr/sap/ /sapmnt/hana/usr/sap/

        $ mkdir -p /sapmnt/hana/hana/{data,log,shared,backup/{data,log}}
        $ chown root:sapsys /sapmnt/hana/*
        $ rsync -av /hana/ /sapmnt/hana/hana/

        $ vi /etc/fstab
        | /sapmnt/hana/usr/sap          /usr/sap           none bind 0 0
        | /sapmnt/hana/hana/data        /hana/data         none bind 0 0
        | /sapmnt/hana/hana/log         /hana/log          none bind 0 0
        | /sapmnt/hana/hana/shared      /hana/shared       none bind 0 0
        | /sapmnt/hana/hana/backup/data /hana/backup/data  none bind 0 0
        | /sapmnt/hana/hana/backup/log  /hana/backup/log   none bind 0 0
        $ mount -a

### Upgrade of HANA DB

    ===============================================================================================
    Upgrade of HANA volume size by LVM
    ===============================================================================================
    1. Command sets
      $ sudo su -
      $ sudo -i
      $ su - hdbadm
      $ su - root

      $ shutdown -r -t 4 now
      $ poweroff
      $ shutdown -h

      $ df -h
      $ df -alh

      $ lsblk
      $ fdisk -h
      $ fdisk /dev/xvdb
      $ mount /dev/xvdb1 /mnt/
      $ mount -a
      $ mkfs.xfs /dev/xvdb1
      $ mount /deb/xvdb1 sysfiles/

      $ cp -R . /mnt/ -v
      $ rsync -av /hana/log/HDB/ /mnt/log/

      $ service --status-all

      $ lsof | grep hana

      $ screen
      $ screen -A -D

      $ mount /dev/xvdb1 sysfiles/
      $ mount /dev/xvdc1 data/
      $ mount /dev/xvdd1 log/

      $ /etc/init.d/sapinit stop
      $ /etc/fstab

    2. Case for lots of volumes: scripts for LVM
      $ pvcreate /dev/xvde
      $ vgextend vgcal /dev/xvde
      $ pvmove --alloc anywhere /dev/xvdj /dev/xvde

      $ lvextend -l +100%FREE /dev/mapper/vgcal-dbdata
      $ resize2fs /dev/mapper/vgcal-dbdata
      $ xfs_growfs /dev/mapper/vgcal-dbdata

      $ vi create_lvm_volume.sh
      |!/bin/bash
      | for i in (/dev/xvdn /dev/xvdm /dev/xvdl /dev/xvdk /dev/xvdj /dev/xvdi /dev/xvdh
      |            /dev/xvds /dev/xvdr /dev/xvdq /dev/xvdp /dev/xvdo);
      | do
      |     pvmove $i /dev/xvde
      | done

    3. LVM suggestion from PCS team
      $ pvcreate $NEUES_VOLUME
      $ vgextend vgcal /dev/$NEUE_VOLUME

      -- Für jedes vorhandene Physical Volume
      $ pvmove --alloc anywhere $ALTES_PV $NEUEV_VOLUME

      -- Alte Volumes aus Volume Group entfernen
      $ vgreduce vgcal /dev/xvdh /dev/xvdi /dev/xvdj
      $ lvextend +L100%FREE /dev/mapper/vgcal-dbdata
      $ resize2fs  /dev/mapper/vgcal-dbdata

      - oder ein Alternative wäre
      $ xfs_growfs /hana/data/HDB

### NFS

    NFS(Network File System)
      exportfs, nfsstat, showmout, rpcinfo    at server
      fstab, mount                            at client

    - Securing NFS
      The tcp wrapper / Firewall software can be used to limit access to an NFS server.
      disadvantage of iptables
      TCP Wrapper restrict access by matching usernames, but iptables does not support.
### Storage area network (SAN)
    ===============================================================================================
    SAN
    ===============================================================================================
    - Storage area network (SAN)
      is a network which provides access to consolidated, block level data storage. SANs are
      primarily used to enhance storage devices, such as disk arrays, tape libraries, and optical
      jukeboxes, accessible to servers so that the devices appear to the operating system as
      locally attached devices. A SAN typically has its own network of storage devices that are
      generally not accessible through the local area network (LAN) by other devices.
      The cost and complexity of SANs dropped in the early 2000s to levels allowing wider
      adoption across both enterprise and small to medium-sized business environments.
      A SAN does not provide file abstraction, only block-level operations. However, file systems
      built on top of SANs do provide file-level access, and are known as shared-disk file systems.


<br/><a name="Shell"></a>

# Bash Shell 

    ===============================================================================================
    Bash 
    ===============================================================================================
    - Wenn ich Hilfe brauche unbekannte Programm Name!
      $ whatis <command>         : sucht Erklaerung der Befehl                            
      $ apropos <command>        : search the whatis database for complete words with apropos
      $ whereis <command>        : zeigt Pfade zu Binaer und /oder Konfigurationsdateien
      $ which <command>          : zeigt Pfade zu ausfuehrbaren Dateien.                     
      $ man -k <command>         : Pfade der Manpages und Pfade zu Programmquellen
      $ <command> --help         : typical help

    - useful tips for ls
      $ ls -l 'which locate'     : list of location indicated by 'which locate'
      $ ls -l $(which passwd)

      $ ls -li  : Inode show
  	  $ ls -lS  : sort by Size
  	  $ ls -lc  : sort by last modification of file status information


    - Useful command for administration I 
      $ expand    : Converts tabs to spaces
      $ unexpand  : Converts spaces to tab
      $ fmt       : a formatter for simplifying and optimizing text files
      $ nl        : numbers of lines of files
      $ wc        : counts of bytes, characers, words and lines of a file
      $ sort      : sort lines of text files alphabetically
      $ uniq      : removes consecutive duplicate lines
      $ split     : splits a file into different groups/files
      $ cut       : cut the field
      $ paste     : horizontalles cat, paste together lines on a file into vertical columns
      $ join      : horizontalles cat, prints a pair of input lines
      $ pr        : Convertsa text file for printing few page printing
      $ stat      : Status of this files who access, modify, etc
      $ file      : show info about file
      $ type (ls, echo, firefox)         : type zeigt fuer ausfuehrbare Dateien

      
    - Useful command for administration II
      $ who -u        : users information
      $ dmesg         : write kernal message
      $ lspci         : display information PCI buses in the system
      $ lsusb -v      : display information USB buses in the system
      $ lsdev         : display information I/O address, IRQ/DMA channels
      $ iostat        : monitoring system input/output device load
      $ vmstat        : reports virtual memory statistics about processes, memory, paging,
                        block I/O, traps, disks and cpu activity.
      $ mpstat -P 1   : output each available processor, 0 being the first one
      $ free -h       : total amount of physical and virtual memory
      $ w             : Wer ist momentan an System angemeldet? info.  from /var/run/utmp
      $ last          : Wer war momentan an diesem System eingemeldet?
      $ uptime        : how long in service, how many user in machine
      $ lsof /tmp     : open files and corresponding processes.
      $ sar -d        : output disk statistics
      $ fuser         : a block device mounted on that directory
      $ nice          : Prozessprioritaet
      $ renice        : Prozessprioritaet
      $ pgrep         : Wie viele Prozess fuer Kang im Lauf?
      $ pkill         : kill all process of kang?

      $ strace -p program     : Debug program to connect a running process
      $ ltrace cat /dev/null  : Debug program to check a library call tracer
      $ strings /bin/bash     : print characters, useful for reading non-text files.

### find

      Necessariness tools and tips for security
      $ find / -perm -u+s           : SUID bit
      $ find / -perm +4000 -type f  : list of files with SUID bit
      $ find / -perm -g+s           : GUID bit
      $ find /usr -uid 0            : owned by root


### Time syncronization

    $ cat /etc/timezone
    $ tzselect                   : set time zone Europe/Berlin
    $ timedatectl set-ntp true   : NTP network time synch is enable

    $ date
    $ hwclock
    $ ntpdate pool.ntp.org       : access to standard ntp server
    $ ntpq -p                    : information about current ntpd server connection
    $ ntpdc                      : ntp diagnose with interactive mode

### Local information

    $ locale
    $ iconv                   : iconv can use for converting between win(euc-kr) and ubuntu(utf-8)

### Background prozess

    $ bg 1
    $ fg 1
    $ nohup updatedb &
    $ screen (remote shell)

### touch to change create date

    $ touch -d tomorrow test             : 
    $ touch -d '1 day ago' test          : 
    $ touch -d '5 years ago' test        : 
    $ touch test{1..10}                  : 

    $ touch -t YYMMDDHHMM fileName       :  set the timestamp 
    $ touch -r file2 file1               :  file2 is updated with the time stamp of file1

### truncate

    $ cp original.output backup.output
    $ truncate -s 0 original.output
    $ cat backup.output > original.output


<br/><a name="Files"></a>

# Files & Directory 

### permission and owner for directory

      $ sudo chmod 755 directory

      $ sudo chown -R user:group  directory
      $ sudo chown -R kang:admin  backup_donghwa

      chmod 755  :  chmod u=rwx,g=rx,o=rx

      Symbolic:  rwx r-x r-x 
      Decimal:    7   5   5 

      chmod 666  :  chmod a=rw, read and write by everyone

      chmod +x   :  chmod ugo+x
      chmod a+x  :  chmod ugo+x  a=all

      chmod u+x  :  Add excute permission to a file/directory for user
      chmod u+X  :  Change execute permission only on the directories

      chmod o-w  :  to remove the write permission for others

### chgrp 

      $ chown kang:admin myfile     : owner:group
      $ chgrp kim myfile            : nur gruppe aendern

### “No such file or directory” error when executing a binary

* Two cases: 

      $ ./binaryfile
      ./binaryfile: error while loading shared libraries: libbooster.so.0: cannot open shared object file: No such file or directory

      $ ./binaryfile
      -bash: ./binaryfile: No such file or directory         : missing a Program Interpreter while above is missing Libraries

* Solution:

      $ objdump -p binaryfile | grep NEEDED

      $ ldd binaryfile

      $ readelf -a binaryfile | grep NEEDED
      $ readelf -a binaryfile | grep interpreter


<br/><a name="Logging"></a>

# Logging

### Log system protocol & analysis

      Where is major log files?
      # /var/log/dmesg      : booting message in RAMdisk with Ring buffer
      # /var/log/messages   : system log
      # /var/log/secure     : login log, authentication and authorization privileges
      # /var/spool/cron     : cron logs
      # /var/log/mail.debug : for mail debugging
      $ cat /var/log/*

      Einsatz von Logdateien zur Fehlersuche
      $ less /var/log/messages
      $ tail -f /var/log/messages   : zeigt "Live" neue Zeilen an.
      $ grep sshd /var/log/messages | grep invalide | less

      $ cat /etc/syslog.conf   : log system configuration, syslog-ng gibt auch
      $ cat /etc/rsyslog.conf  : Heute benutzen diese Konfiguration Datei

      $ /sbin/klogd            : kernel message daemon in init-process
      $ /proc/kmsg             : einstellungs Datei von klogd

      Ruuning process with PID
      $ cat /proc/2352/environ
      $ cat /proc/2352/environ | tr "\000" "\n"

      $ logger -t my_log_message  here is my message!



      $ cat /etc/systemd/journald.conf
      $ cat /var/log/journal/    : somtimes not here, but in /var/log/syslog

### journal

    wenn Sie systemd statt upstart oder SysVinit, dann journald ist antwortlich.
    $ journalctl --since "2015-01-10" --until "2015-01-11 03:00"

    $ journalctl --list­-boots                   : To get a list of boots
    $ journalctl -b                             : to get the all the logs for the current boot,
    $ journalctl -b -1                          : to get the previous boots
    $ journalctl --sinc­e="2­021­-01-30 18:17:16"  : specific time using --since and --until
    $ journalctl --since "20 min ago"   
    $ journalctl -u systemd-*
    $ journalctl --user-unit my-application
    $ jour­nalctl _UID=100
    $ journalctl -p err..alert                  : Priority
    $ journalctl -u apache -n 10
    $ journalctl -f -u nginx
    $ journalctl --no-pager
    $ journalctl --vacu­um-­tim­e=2­weeks
    $ journalctl -b -u docker -o json


### logrotate

    logrotate in order to save log files by rotation
    /etc/logrotate.conf             : Configuration options.
    /etc/logrotate.d                : contents, references, stores application-specific log settings
    /var/lib/logrotate.status       : Default state file.

    $ logrotate log-rotation.conf                    : configure
    $ logrotate -f log-rotation.conf                 : run it
    $ logrotate -d /etc/logrotate.d/apache2.conf

    --------------------------------------------
    <global directive 1>
    <global directive 2>
    <file path matchers 1> {
        <directive 1>
        <directive 2>
        ...
        <directive n>
    }

    <file path matchers 2a> <file path matchers 2b> {
        <directive 1>
        <directive 2>
        ...
        <directive n>
    }    
    --------------------------------------------

    --------------------------------------------
    compress
    /var/log/nginx/* {
        rotate 3
        daily
    }
    /var/log/nginx/error.log {
        rotate 3
        size 1M
        lastaction
            /usr/bin/killall -HUP nginx
        endscript
        nocompress
    }
    --------------------------------------------


<div><br/>
&raquo; Back to <a href="#contents">Contents</a> | <a href="../docs/README.md">Docs</a>
</div>
